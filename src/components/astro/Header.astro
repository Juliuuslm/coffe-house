---
const navLinks = [
  { name: 'Home', href: '/' },
  { name: 'About', href: '/about' },
  { name: 'Menu', href: '/menu' },
  { name: 'Gallery', href: '/gallery' },
  { name: 'Contact', href: '/contact' },
];

const currentPath = Astro.url.pathname;
---

<header id="header" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300">
  <div class="container-custom">
    <div class="flex items-center justify-between py-6">
      <!-- Logo -->
      <a href="/" class="text-2xl font-primary font-bold text-heading hover:text-primary transition-colors">
        <span class="hidden sm:inline">Coffee House</span>
        <span class="sm:hidden">CH</span>
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden lg:flex items-center gap-10">
        {
          navLinks.map((link) => (
            <a
              href={link.href}
              class={`font-secondary font-medium text-base transition-colors relative group ${
                currentPath === link.href
                  ? 'text-primary'
                  : 'text-heading hover:text-primary'
              }`}
            >
              {link.name}
              <span
                class={`absolute bottom-0 left-0 w-0 h-0.5 bg-primary transition-all duration-300 group-hover:w-full ${
                  currentPath === link.href ? 'w-full' : ''
                }`}
              />
            </a>
          ))
        }
      </nav>

      <!-- CTA Button -->
      <div class="hidden lg:block">
        <a href="/contact" class="btn-primary btn-sm">
          Reserve Table
        </a>
      </div>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-button"
        class="lg:hidden flex flex-col gap-1.5 w-8 h-8 justify-center items-center"
        aria-label="Toggle menu"
      >
        <span class="block w-6 h-0.5 bg-heading transition-all duration-300"></span>
        <span class="block w-6 h-0.5 bg-heading transition-all duration-300"></span>
        <span class="block w-6 h-0.5 bg-heading transition-all duration-300"></span>
      </button>
    </div>
  </div>

  <!-- Mobile Menu Backdrop -->
  <div
    id="mobile-menu-backdrop"
    class="lg:hidden fixed inset-0 bg-black/50 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300"
    style="top: 80px; z-index: 40;"
  ></div>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="lg:hidden fixed inset-0 bg-white transform translate-x-full transition-all duration-300 ease-out shadow-2xl"
    style="top: 80px; z-index: 45;"
  >
    <nav class="container-custom py-8 flex flex-col gap-6 h-full overflow-y-auto">
      {
        navLinks.map((link, index) => (
          <a
            href={link.href}
            data-menu-link
            class={`mobile-menu-link font-secondary font-semibold text-2xl transition-all duration-300 hover:pl-4 ${
              currentPath === link.href
                ? 'text-primary'
                : 'text-heading hover:text-primary'
            }`}
            style={`transition-delay: ${index * 50}ms;`}
          >
            <span class="flex items-center gap-3">
              <span class="w-0 h-0.5 bg-primary transition-all duration-300 group-hover:w-8"></span>
              {link.name}
            </span>
          </a>
        ))
      }
      <div class="pt-6 border-t border-gray-200 space-y-4">
        <a href="/contact" class="btn-primary w-full block text-center" data-menu-link>
          Reserve Table
        </a>
        <div class="flex gap-4 justify-center" data-menu-link>
          <a href="#" class="w-10 h-10 rounded-full border-2 border-gray-300 flex items-center justify-center hover:border-primary hover:text-primary transition-colors">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z" />
            </svg>
          </a>
          <a href="#" class="w-10 h-10 rounded-full border-2 border-gray-300 flex items-center justify-center hover:border-primary hover:text-primary transition-colors">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <rect width="20" height="20" x="2" y="2" rx="5" ry="5" />
              <path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37zm1.5-4.87h.01" />
            </svg>
          </a>
          <a href="#" class="w-10 h-10 rounded-full border-2 border-gray-300 flex items-center justify-center hover:border-primary hover:text-primary transition-colors">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z" />
            </svg>
          </a>
        </div>
      </div>
    </nav>
  </div>
</header>

<script>
  // Store cleanup function to remove event listeners
  let cleanup: (() => void) | null = null;

  function initHeader() {
    // Clean up previous event listeners
    if (cleanup) {
      cleanup();
    }

    const header = document.getElementById('header');
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');

    if (!header || !mobileMenuButton || !mobileMenu || !mobileMenuBackdrop) return;

    // Check current menu state from DOM and force close if needed
    const isCurrentlyOpen = !mobileMenu.classList.contains('translate-x-full');
    if (isCurrentlyOpen) {
      mobileMenu.classList.add('translate-x-full');
      mobileMenu.classList.remove('translate-x-0');
      mobileMenuBackdrop.classList.add('opacity-0', 'pointer-events-none');
      mobileMenuBackdrop.classList.remove('opacity-100');
      document.body.style.overflow = '';
    }

    // Mobile menu toggle state
    let isMenuOpen = false;

    // Sticky header on scroll
    const handleScroll = () => {
      const currentScroll = window.pageYOffset;

      if (currentScroll > 100) {
        header.classList.add('bg-white', 'shadow-lg');
      } else {
        header.classList.remove('bg-white', 'shadow-lg');
      }
    };

    const openMenu = () => {
      isMenuOpen = true;
      mobileMenu.classList.remove('translate-x-full');
      mobileMenu.classList.add('translate-x-0');
      mobileMenuBackdrop.classList.remove('opacity-0', 'pointer-events-none');
      mobileMenuBackdrop.classList.add('opacity-100');
      document.body.style.overflow = 'hidden';

      // Animate hamburger to X
      const spans = mobileMenuButton.querySelectorAll('span');
      spans[0].style.transform = 'rotate(45deg) translateY(8px)';
      spans[1].style.opacity = '0';
      spans[2].style.transform = 'rotate(-45deg) translateY(-8px)';

      // Stagger animation for menu links
      const menuLinks = mobileMenu.querySelectorAll('[data-menu-link]');
      menuLinks.forEach((link, index) => {
        setTimeout(() => {
          (link as HTMLElement).style.opacity = '1';
          (link as HTMLElement).style.transform = 'translateX(0)';
        }, index * 50);
      });
    };

    const closeMenu = () => {
      isMenuOpen = false;
      mobileMenu.classList.add('translate-x-full');
      mobileMenu.classList.remove('translate-x-0');
      mobileMenuBackdrop.classList.add('opacity-0', 'pointer-events-none');
      mobileMenuBackdrop.classList.remove('opacity-100');
      document.body.style.overflow = '';

      // Animate X back to hamburger
      const spans = mobileMenuButton.querySelectorAll('span');
      spans[0].style.transform = '';
      spans[1].style.opacity = '1';
      spans[2].style.transform = '';

      // Reset menu links
      const menuLinks = mobileMenu.querySelectorAll('[data-menu-link]');
      menuLinks.forEach((link) => {
        (link as HTMLElement).style.opacity = '0';
        (link as HTMLElement).style.transform = 'translateX(20px)';
      });
    };

    const handleMenuButtonClick = () => {
      if (isMenuOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    };

    const handleBackdropClick = () => {
      closeMenu();
    };

    const handleLinkClick = () => {
      closeMenu();
    };

    // Add event listeners
    window.addEventListener('scroll', handleScroll);
    mobileMenuButton.addEventListener('click', handleMenuButtonClick);
    mobileMenuBackdrop.addEventListener('click', handleBackdropClick);

    // Close menu on link click
    const mobileLinks = mobileMenu.querySelectorAll('a');
    mobileLinks.forEach((link) => {
      link.addEventListener('click', handleLinkClick);
    });

    // Initialize menu links with hidden state
    const menuLinks = mobileMenu.querySelectorAll('[data-menu-link]');
    menuLinks.forEach((link) => {
      (link as HTMLElement).style.opacity = '0';
      (link as HTMLElement).style.transform = 'translateX(20px)';
      (link as HTMLElement).style.transition = 'opacity 0.3s, transform 0.3s';
    });

    // Store cleanup function
    cleanup = () => {
      window.removeEventListener('scroll', handleScroll);
      mobileMenuButton.removeEventListener('click', handleMenuButtonClick);
      mobileMenuBackdrop.removeEventListener('click', handleBackdropClick);
      mobileLinks.forEach((link) => {
        link.removeEventListener('click', handleLinkClick);
      });
    };

    // Store closeMenu function globally for astro:before-swap
    (window as any).__closeMenu = closeMenu;
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initHeader);

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initHeader);

  // Force close menu before page swap to prevent state issues
  document.addEventListener('astro:before-swap', () => {
    if ((window as any).__closeMenu) {
      (window as any).__closeMenu();
    }
  });
</script>

<style>
  #mobile-menu {
    height: calc(100vh - 80px);
  }
</style>
